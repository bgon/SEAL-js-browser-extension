(()=>{"use strict";var e={447:function(e,t,i){var a=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))((function(n,s){function r(e){try{d(a.next(e))}catch(e){s(e)}}function o(e){try{d(a.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Crypto=void 0;const n=i(185);class s{static getAlgorithmParameters(e,t,i){let a,n=t;if("rsa"==i)a={name:"RSASSA-PKCS1-v1_5",hash:{name:n}};else if("ec"==i){let t;switch(e.length){case 91:default:t="P-256";break;case 120:t="P-384";break;case 156:t="P-521"}a={name:"ECDSA",hash:n,namedCurve:t}}else a={name:"RSASSA-PKCS1-v1_5",hash:{name:n}};return a}static getCryptoKeyLength(e){let t;return"ECDSA"===e.algorithm.name&&(t=parseInt(e.algorithm.namedCurve.replace("P-",""))),"RSASSA-PKCS1-v1_5"===e.algorithm.name&&(t=e.algorithm.modulusLength),t}static importCryptoKey(e,t){return a(this,void 0,void 0,(function*(){return new Promise(((i,s)=>a(this,void 0,void 0,(function*(){const a=yield crypto.subtle.importKey("spki",(0,n.base64ToUint8Array)(e),t,!0,["verify"]).catch((e=>{s({message:e})}));i(a)}))))}))}static verifySignature(e,t,i,n){return a(this,void 0,void 0,(function*(){return"ECDSA"===i.algorithm.name&&(t=s.convertEcdsaAsn1Signature(t)),crypto.subtle.verify(n,i,t,e)}))}static convertEcdsaAsn1Signature(e){const t=s.readAsn1IntegerSequence(e);if(2!==t.length)throw new Error("Expected 2 ASN.1 sequence elements");let[i,a]=t;if(0===i[0]&&i.byteLength%16==1&&(i=i.slice(1)),0===a[0]&&a.byteLength%16==1&&(a=a.slice(1)),i.byteLength%16==15&&(i=new Uint8Array((0,n.mergeBuffer)(new Uint8Array([0]),i))),a.byteLength%16==15&&(a=new Uint8Array((0,n.mergeBuffer)(new Uint8Array([0]),a))),i.byteLength%16!=0)throw new Error("unknown ECDSA sig r length error");if(a.byteLength%16!=0)throw new Error("unknown ECDSA sig s length error");return(0,n.mergeBuffer)(i,a)}static readAsn1IntegerSequence(e){if(48!==e[0])throw new Error("Input is not an ASN.1 sequence");const t=e[1],i=[];let a=e.slice(2,2+t);for(;a.length>0;){if(2!==a[0])throw new Error("Expected ASN.1 sequence element to be an INTEGER");const e=a[1];i.push(a.slice(2,2+e)),a=a.slice(2+e)}return i}}t.Crypto=s},511:function(e,t){var i=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))((function(n,s){function r(e){try{d(a.next(e))}catch(e){s(e)}}function o(e){try{d(a.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DoH=void 0,t.DoH=class{static getDNSTXTRecords(e,t="https://mozilla.cloudflare-dns.com/dns-query"){return i(this,void 0,void 0,(function*(){return console.time("getDNS_"+t),new Promise(((a,n)=>i(this,void 0,void 0,(function*(){let i;i=`${t}?name=${e}&type=TXT`,yield fetch(i,{method:"GET",headers:{accept:"application/dns-json"}}).then((e=>{if(e.ok)return e.json();throw new Error("Unexpected server response, code: "+e.status)})).then((e=>{if(!e.Answer)throw new Error("No Answer field from DoH");{let t=[];e.Answer.forEach((e=>{let i={};e.data.replace(/".{0,1}"/g,"").replace(/"/g,"").split(" ").forEach((e=>{const t=e.split("=");i[t[0]]=t[1]})),t.push(i)})),a(t)}})).catch((e=>{n(e)})),console.timeEnd("getDNS_"+t)}))))}))}}},927:function(e,t,i){var a=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))((function(n,s){function r(e){try{d(a.next(e))}catch(e){s(e)}}function o(e){try{d(a.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const n=i(871),s=i(582);chrome.runtime.onMessage.addListener((e=>a(void 0,void 0,void 0,(function*(){"viewMediaSignature"===e.action&&s.MediaAsset.UrlToAsset(e.url).then((e=>{!function(e){a(this,void 0,void 0,(function*(){try{let t=yield n.SEAL.validateSig(e,!0);r(t)}catch(e){console.error(e),r({message:"Validation Error",reason:e})}}))}(e)})).catch((t=>{chrome.runtime.sendMessage({action:"openTab",imageSrc:e.url},(e=>{})),r({message:"Opening a new tab to fetch the image...",reason:t})}))}))));const r=e=>a(void 0,void 0,void 0,(function*(){const t=document.createElement("dialog");t.setAttribute("style","\n        position: fixed;\n        background: transparent;\n        height: 100%;\n        width: 100%;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        z-index: 1000;\n        border: 0px;");const i=document.createElement("iframe");i.id="modal-iframe",i.setAttribute("style","\n        width:512px;\n        height:512px;\n        box-shadow: 0px 0px 24px 0px rgba(66, 68, 90, 1);\n        border-radius: 20px;\n        "),i.src=chrome.runtime.getURL("modal.html"),i.frameBorder="0",i.onload=function(){var t;null===(t=i.contentWindow)||void 0===t||t.postMessage(e,"*")};const a=document.createElement("button");a.setAttribute("style","\n        background-color: #fff;\n        color: #000;\n        padding: 8px 12px;\n        font-size: 16px;\n        border: none;\n        border-radius: 20px;\n        position: relative;\n        top: -256px;\n        left: 528px;\n        "),a.innerHTML="X",a.addEventListener("click",(()=>{t.close()})),t.addEventListener("close",(e=>{t.remove()})),t.appendChild(i),t.appendChild(a),t.appendChild(i),document.body.appendChild(t),t.showModal()}))},582:function(e,t,i){var a=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))((function(n,s){function r(e){try{d(a.next(e))}catch(e){s(e)}}function o(e){try{d(a.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.MediaAsset=void 0;const n=i(109);t.MediaAsset=class{static readChunks(e){console.time("readChunks"),e.size=e.data.byteLength,e.data=new Uint8Array(e.data),e.mime||(e.mime=(0,n.detectMimeType)(e.data));let t=!1;e.data.byteLength-65536>65536&&(t=!0);for(let i=0;i<e.data.length;i++)if(i>65536&&!0===t&&(i=e.data.byteLength-65536,t=!1),60==e.data[i]&&115==e.data[i+1]&&101==e.data[i+2]&&97==e.data[i+3]&&108==e.data[i+4]||60==e.data[i]&&63==e.data[i+1]&&115==e.data[i+2]&&101==e.data[i+3]&&97==e.data[i+4]&&108==e.data[i+5]||38==e.data[i]&&108==e.data[i+1]&&116==e.data[i+2]&&59==e.data[i+3]&&115==e.data[i+4]&&101==e.data[i+5]){const t=i;let a=!0;for(;a;)(47==e.data[i]&&62==e.data[i+1]||63==e.data[i]&&62==e.data[i+1]||47==e.data[i]&&38==e.data[i+1]&&103==e.data[i+2]&&116==e.data[i+3])&&(a=!1),i++;const n=(new TextDecoder).decode(e.data.slice(t,i+1)).replace(/\\/gm,"");e.seal_segments||(e.seal_segments=[]),e.seal_segments.push({string:n,signature_end:i-2})}return console.timeEnd("readChunks"),e}static assembleBuffer(e,t){const i=t.reduce(((e,[t,i])=>e+(i-t)),0),a=new Uint8Array(i);let n=0;return t.forEach((([t,i])=>{const s=e.data.slice(t,i);a.set(new Uint8Array(s),n),n+=s.byteLength})),a}static fileToAsset(e){return a(this,void 0,void 0,(function*(){let t={url:"localhost",domain:"localhost",name:e.name};return t.blob=new Blob([e],{type:e.type}),t.data=yield t.blob.arrayBuffer(),t.mime=t.blob.type,0===t.mime.length&&(t.mime=(0,n.detectMimeType)(t.data)),t.size=t.blob.size,(t.mime.includes("image")||t.mime.includes("audio")||t.mime.includes("video"))&&(t.url=URL.createObjectURL(t.blob)),t}))}static UrlToAsset(e){return a(this,void 0,void 0,(function*(){let t={url:e};try{let e=new URL(t.url);t.domain=e.hostname}catch(e){throw new Error("Not an url")}t.name=(t.url.match(/^\w+:(\/+([^\/#?\s]+)){2,}(#|\?|$)/)||[])[2]||"";try{const e=yield fetch(t.url);if(!e.ok)throw new Error("Failed to fetch media");t.blob=yield e.blob(),t.data=yield t.blob.arrayBuffer(),t.mime=t.blob.type,t.size=t.blob.size,0===t.mime.length&&(t.mime=(0,n.detectMimeType)(t.data))}catch(e){throw new Error(e)}return t}))}}},109:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.detectMimeType=void 0;const i=new TextDecoder,a={dcdc:"application/cpl+xml","1f8b08":"application/gzip",25504446:"application/pdf","7b5c72746631":"application/rtf","526172211A0700":"application/vnd.rar","526172211a070100":"application/vnd.rar","425a68":"application/x-bzip2",7573746172003030:"application/x-tar",7573746172202e3:"application/x-tar","504b0304":"application/zip","504b0506":"application/zip","504b0708":"application/zip","2321414d52":"audio/AMR","2e736e64":"audio/basic","646e732e":"audio/basic","4d546864":"audio/midi","667479704d344120":"audio/mp4",fffb:"audio/mp3",fff3:"audio/mp3",fff2:"audio/mp3",ffe3:"audio/mp3",494433:"audio/mp3",fff1:"audio/aac",fff9:"audio/aac",57415645:"audio/wav","464f524d00":"audio/x-aiff","664c6143":"audio/x-flac","424d":"image/bmp","4449434D":"image/dcm",47494638:"image/gif","0000000C6A502020":"image/jp2",ffd8ff:"image/jpeg","89504e470d0a1a0a":"image/png","49492a00":"image/tiff","4d4d002a":"image/tiff","3c737667":"image/svg",38425053:"image/vnd.adobe.photoshop",57454250:"image/webp","010009000003":"image/wmf",d7cdc69a:"image/wmf",5035:"image/x-portable-graymap",5036:"image/x-portable-pixmap","01da01010003":"image/x-rgb","67696d7020786366":"image/x-xcf","0000001466747970336770":"video/3gpp2","0000002066747970336770":"video/3gpp2","6674797069736f6d":"video/mp4","667479704d534e56":"video/mp4","000000186674797033677035":"video/mp4","0000001c667479704d534e56012900464d534e566d703432":"video/mp4",6674797033677035:"video/mp4","00000018667479706d703432":"video/mp4","667479706d703432":"video/mp4",ffd8:"video/mpeg","000001ba":"video/mpeg","4F676753":"video/ogg",1466747970717420:"video/quicktime",6674797071742020:"video/quicktime","6d6f6f76":"video/quicktime","20667479704d3456":"video/x-flv","464c5601":"video/x-flv","1a45dfa3":"video/x-matroska"};t.detectMimeType=function(e){const t=Array.from(e.slice(0,16)).map((e=>e.toString(16).padStart(2,"0"))).join("");for(const[e,i]of Object.entries(a))if(t.includes(e))return i;let n=i.decode(e.slice(1,32));return n.includes("mp4")?"video/mp4":n.includes("heic")?"image/heif":n.includes("jumb")?"application/c2pa":n.includes("DICM")?"image/dcm":/^[\x09\x0A\x0D\x20-\x7E\x80-\xFF]*$/m.test(n)?n.includes("DOCTYPE")&&n.includes("html")?"text/html":n.includes("DOCTYPE")&&n.includes("svg")?"image/svg":"text/plain":"unknown"}},871:function(e,t,i){var a=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))((function(n,s){function r(e){try{d(a.next(e))}catch(e){s(e)}}function o(e){try{d(a.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}d((a=a.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAL=t.ValidationError=void 0;const n=i(582),s=i(511),r=i(447),o=i(185);class d extends Error{constructor({name:e,message:t,cause:i}){super(t),this.name=e,this.cause=i}}t.ValidationError=d;class c{static parse(e){console.time("parse"),e.seal_segments[0].string.match(/&quot;/g)&&(e.seal_segments[0].signature_end=e.seal_segments[0].signature_end-5);const t=e.seal_segments[0].string.replace(/<.{0,1}seal /,"").replace(/\?{0,1}\/>/,"").replace(/&quot;/g,'"').replace("<seal:seal>","").replace("/&","").replace("&lt;seal ",""),i={},a=/ ?(.*?)=\"(.*?)\"/gm;let n;for(;null!==(n=a.exec(t));)n.index===a.lastIndex&&a.lastIndex++,i[n[1]]=n[2];switch(i.da||(i.da="sha256"),i.da){case"sha256":default:i.da="SHA-256";break;case"sha384":i.da="SHA-384";break;case"sha512":i.da="SHA-512";break;case"sha1":i.da="SHA-1"}if(!(i.seal&&i.d&&i.ka&&i.s))throw new d({name:"SEAL_RECORD_MISSING_PARAMETERS",message:"The SEAL record is incomplete"});this.record=i,console.timeEnd("parse")}static validateSig(e,t=!1){return a(this,void 0,void 0,(function*(){return new Promise(((i,l)=>a(this,void 0,void 0,(function*(){var a;let u={};if(!(e=n.MediaAsset.readChunks(e)).seal_segments)return u.message="😢 No SEAL signatures found.",u.filename=e.name,u.filemime=e.mime,u.filesize=e.size-1,u.filedomain=e.domain,u.url=e.url,i(u);this.validation={digest_summary:"",signature_bytes:new Uint8Array,signature_encoding:"",verbose:t,doh_api:"https://mozilla.cloudflare-dns.com/dns-query"},c.parse(e);let h=this.record.d;if(!this.public_keys[h]){let e=yield s.DoH.getDNSTXTRecords(h,this.validation.doh_api).catch((e=>l(new d({name:"DNS_LOOKUP",message:"Querying DoH "+this.record.d+" DNS for a TXT record failed",cause:e.message}))));if(!e)return;if(e.forEach((e=>{e.ka&&e.seal&&e.p&&(this.public_keys[h]||(this.public_keys[h]={}),"rsa"===e.ka&&(this.public_keys[h].rsa=e.p),"ec"===e.ka&&(this.public_keys[h].ec=e.p))})),!this.public_keys[h])return l(new d({name:"DNS_LOOKUP",message:"Public key not found or corrupted",cause:JSON.stringify(e)}))}yield c.digest(e).catch((e=>{l(new d({name:"DIGEST_ERROR",message:"Digest can not be processed",cause:e.message}))})),yield c.doubleDigest().catch((e=>{l(new d({name:"DIGEST_ERROR",message:"doubleDigest can not be processed",cause:e.message}))}));let g=r.Crypto.getAlgorithmParameters(this.public_keys[this.record.d][this.record.ka],this.record.da,this.record.ka),m=yield r.Crypto.importCryptoKey(this.public_keys[this.record.d][this.record.ka],g).catch((e=>{l(new d({name:"KEY_IMPORT_ERROR",message:"crypto.subtle.importKey couldn't process the data",cause:e.message}))}));if(this.validation.digest2&&this.validation.signature&&m){console.time("verifySignature");let t=yield r.Crypto.verifySignature(this.validation.digest2,this.validation.signature_bytes,m,g).catch((e=>l(new d({name:"SIGNATURE_VERIFY_ERROR",message:"The signature can not be verified",cause:e.message}))));if(console.timeEnd("verifySignature"),!0===t?(u.message="✅ SEAL record #1 is valid.",u.valid=!0):(u.message="⛔ SEAL record #1 is NOT valid.",u.valid=!1),u.filename=e.name,u.filemime=e.mime,this.validation.verbose){u.filesize=e.size-1,u.filedomain=e.domain,u.url=e.url,u.doh_api=this.validation.doh_api,u.domain=this.record.d,this.validation.signature_date&&(u.signed_on=(0,o.createDate)(this.validation.signature_date).toISOString()),u.digest=Array.from(this.validation.digest1).map((e=>e.toString(16).padStart(2,"0"))).join(""),this.validation.digest2=new Uint8Array(yield crypto.subtle.digest(this.record.da,this.validation.digest2)),u.double_digest=Array.from(this.validation.digest2).map((e=>e.toString(16).padStart(2,"0"))).join(""),u.key_algorithm=`${this.record.ka.toUpperCase()}, ${r.Crypto.getCryptoKeyLength(m)} bits`,u.digest_algorithm=this.record.da,u.key_base64=this.public_keys[this.record.d][this.record.ka];let t=[];null===(a=this.validation.digest_ranges)||void 0===a||a.forEach((e=>{t.push(e[0]+"-"+(e[1]-1))})),u.signed_bytes=t,u.spans=this.validation.digest_summary,u.user=this.record.id,this.record.copyright&&(u.copyright=this.record.copyright),this.record.info&&(u.comment=this.record.info)}i(u)}else l(new d({name:"VALIDATION_MISSING_PARAMETERS",message:"Double Digest or Signature is missing"}))}))))}))}static digest(e){return a(this,void 0,void 0,(function*(){return new Promise(((t,i)=>a(this,void 0,void 0,(function*(){let a,s;console.time("digest"),this.validation.digest_ranges=[],this.record.b&&(this.record.b.split(",").forEach((t=>{var n;let r,o;[r,o]=t.split("~");let d=r.split("-"),c=r.split("+");switch(d[1]?(r=d[0],d=parseInt(d[1])):d=0,c[1]?(r=c[0],c=parseInt(c[1])):c=0,r){case"F":r=0,a||(a="Start of file");break;case"f":r=e.size,a||(a="End of file");break;case"S":r=e.seal_segments[0].signature_end-this.record.s.length,a||(a="Start of signature");break;case"s":r=e.seal_segments[0].signature_end,a||(a="End of signature");break;case"P":case"p":r=0;break;default:return i(new Error("ranges start error"))}switch(r=r+c+d,d=o.split("-"),c=o.split("+"),d[1]?(o=d[0],d=parseInt(d[1])):d=0,c[1]?(o=c[0],c=parseInt(c[1])):c=0,o){case"F":o=0,s="Start of file";break;case"f":o=e.size,s="End of file";break;case"S":o=e.seal_segments[0].signature_end-this.record.s.length,s="start of signature";break;case"s":o=e.seal_segments[0].signature_end,s="end of signature";break;case"P":case"p":o=0;break;default:return i(new Error("ranges stop error"))}o=o+c+d,null===(n=this.validation.digest_ranges)||void 0===n||n.push([r,o]),this.validation.digest_summary=`${a} to ${s}`})),crypto.subtle.digest(this.record.da,n.MediaAsset.assembleBuffer(e,this.validation.digest_ranges)).then((e=>{this.validation.digest1=new Uint8Array(e),console.timeEnd("digest"),t()})).catch((e=>{i(e)})))}))))}))}static doubleDigest(){return new Promise(((e,t)=>a(this,void 0,void 0,(function*(){console.time("doubleDigest");let i=[];if(this.record.sf&&(i=this.record.sf.split(":")),this.record.s){this.validation.signature=this.record.s;try{i.length>0?i.forEach((e=>{if("base64"!=e&&"hex"!=e&&"HEX"!=e&&"bin"!=e||(this.validation.signature_encoding=e,this.validation.signature&&(this.validation.signature=this.validation.signature.replace(e+":",""))),e.includes("date")){let t=parseInt(e.charAt(e.length-1));isNaN(t)?(this.validation.signature=this.record.s.substring(15,this.record.s.length),this.validation.signature_date=this.record.s.substring(0,14)):(this.validation.signature=this.record.s.substring(16+t,this.record.s.length),this.validation.signature_date=this.record.s.substring(0,15+t))}})):this.validation.signature_encoding="base64","hex"!=this.validation.signature_encoding&&"HEX"!=this.validation.signature_encoding||(this.validation.signature_bytes=(0,o.hexToUint8Array)(this.validation.signature)),"base64"==this.validation.signature_encoding&&(this.validation.signature_bytes=(0,o.base64ToUint8Array)(this.validation.signature))}catch(e){return t(e)}}else t(new d({name:"SIGNATURE_MISSING",message:"The signature is missing"}));let a="";this.validation.signature_date&&(a=this.validation.signature_date+":"),this.record.id&&(a=a+this.record.id+":");let n=(new TextEncoder).encode(a);this.validation.digest1?(this.validation.digest2=(0,o.mergeBuffer)(n,this.validation.digest1),console.timeEnd("doubleDigest"),e()):t(new d({name:"DIGEST_MISSING",message:"The digest is missing"}))}))))}}t.SEAL=c,c.public_keys={},c.seals=[]},185:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createDate=t.mergeBuffer=t.hexToUint8Array=t.base64ToUint8Array=void 0,t.base64ToUint8Array=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i},t.hexToUint8Array=function(e){if(e.length%2!=0)throw new Error("Hex string must have an even length");const t=new Uint8Array(e.length/2);for(let i=0;i<e.length;i+=2)t[i/2]=parseInt(e.slice(i,i+2),16);return t},t.mergeBuffer=function(e,t){if(!e)return t;if(!t)return e;const i=new Uint8Array(e.byteLength+t.byteLength);return i.set(e,0),i.set(t,e.byteLength),i},t.createDate=function(e){let t,i=e.split(".");i[1]?(e=i[0],t=i[1]):t="000";const a=e.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1-$2-$3T$4:$5:$6."+t+"Z");return new Date(a)}}},t={};!function i(a){var n=t[a];if(void 0!==n)return n.exports;var s=t[a]={exports:{}};return e[a].call(s.exports,s,s.exports,i),s.exports}(927)})();