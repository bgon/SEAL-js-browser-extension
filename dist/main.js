(()=>{"use strict";var e={447:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(a,r){function s(e){try{d(n.next(e))}catch(e){r(e)}}function o(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.Crypto=void 0;const a=i(185);class r{static getAlgorithmParameters(e,t,i){let n,a=t;if("rsa"==i)n={name:"RSASSA-PKCS1-v1_5",hash:{name:a}};else if("ec"==i){let t;switch(e.length){case 91:default:t="P-256";break;case 120:t="P-384";break;case 156:t="P-521"}n={name:"ECDSA",hash:a,namedCurve:t}}else n={name:"RSASSA-PKCS1-v1_5",hash:{name:a}};return n}static getCryptoKeyLength(e){let t;return"ECDSA"===e.algorithm.name&&(t=parseInt(e.algorithm.namedCurve.replace("P-",""))),"RSASSA-PKCS1-v1_5"===e.algorithm.name&&(t=e.algorithm.modulusLength),t}static importCryptoKey(e,t){return n(this,void 0,void 0,(function*(){return new Promise(((i,r)=>n(this,void 0,void 0,(function*(){const n=yield crypto.subtle.importKey("spki",(0,a.base64ToUint8Array)(e),t,!0,["verify"]).catch((e=>{r(e)}));i(n)}))))}))}static verifySignature(e,t,i,a){return n(this,void 0,void 0,(function*(){return"ECDSA"===i.algorithm.name&&(t=r.convertEcdsaAsn1Signature(t)),crypto.subtle.verify(a,i,t,e)}))}static convertEcdsaAsn1Signature(e){const t=r.readAsn1IntegerSequence(e);if(2!==t.length)throw new Error("Expected 2 ASN.1 sequence elements");let[i,n]=t;if(0===i[0]&&i.byteLength%16==1&&(i=i.slice(1)),0===n[0]&&n.byteLength%16==1&&(n=n.slice(1)),i.byteLength%16==15&&(i=new Uint8Array((0,a.mergeBuffer)(new Uint8Array([0]),i))),n.byteLength%16==15&&(n=new Uint8Array((0,a.mergeBuffer)(new Uint8Array([0]),n))),i.byteLength%16!=0)throw new Error("unknown ECDSA sig r length error");if(n.byteLength%16!=0)throw new Error("unknown ECDSA sig s length error");return(0,a.mergeBuffer)(i,n)}static readAsn1IntegerSequence(e){if(48!==e[0])throw new Error("Input is not an ASN.1 sequence");const t=e[1],i=[];let n=e.slice(2,2+t);for(;n.length>0;){if(2!==n[0])throw new Error("Expected ASN.1 sequence element to be an INTEGER");const e=n[1];i.push(n.slice(2,2+e)),n=n.slice(2+e)}return i}}t.Crypto=r},511:function(e,t){var i=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(a,r){function s(e){try{d(n.next(e))}catch(e){r(e)}}function o(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DoH=void 0,t.DoH=class{static getDNSTXTRecords(e,t="cloudflare"){return i(this,void 0,void 0,(function*(){return console.time("getDNS_"+t),new Promise(((n,a)=>i(this,void 0,void 0,(function*(){let i;i=`${{cloudflare:"https://cloudflare-dns.com/dns-query",mozilla:"https://mozilla.cloudflare-dns.com/dns-query",google:"https://dns.google/resolve"}[t]}?name=${e}&type=TXT`,yield fetch(i,{method:"GET",headers:{accept:"application/dns-json"}}).then((e=>{if(e.ok)return e.json();throw new Error("Unexpected server response, code: "+e.status)})).then((e=>{if(!e.Answer)throw new Error("No Answer field from DoH");{let t=[];e.Answer.forEach((e=>{let i={};e.data.replace(/"/g,"").split(" ").forEach((e=>{const t=e.split("=");i[t[0]]=t[1]})),t.push(i)})),n(t)}})).catch((e=>{a(e)})),console.timeEnd("getDNS_"+t)}))))}))}}},927:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(a,r){function s(e){try{d(n.next(e))}catch(e){r(e)}}function o(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const a=i(871),r=i(109);function s(e,t){const i=document.createElement("div");i.id="seal-modal";const n=document.createElement("div");n.innerHTML=`\n<style>\n        #seal-modal {\n            position: fixed;\n            background-color:rgba(0, 0, 0, 0.5);\n            top: 0;\n            left: 0;\n            height: 100%;\n            width: 100%;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            z-index: 1000;\n        }\n\n        #seal-modal div {\n            max-width: 90%;\n            background-color: white;\n            box-shadow: 0px 0px 24px 0px rgba(66, 68, 90, 1);\n            padding: 10px;\n            border-radius: 10px;\n            display: flex\n        }\n\n        #seal-modal button {\n            height: 25%;\n            background-color: transparent;\n            border-radius: 16px;\n            border: 2px solid #566963;\n            display: inline-block;\n            cursor: pointer;\n            color: #303a37;\n            font-family: Arial;\n            font-size: 16px;\n            padding: 8px 16px;\n            text-decoration: none;\n            margin-top: 16px;\n        }\n\n        #seal-modal .media-preview {\n            background-image: repeating-linear-gradient(45deg, #8e8f98 25%, transparent 25%, transparent 75%, #8e8f98 75%, #8e8f98), repeating-linear-gradient(45deg, #8e8f98 25%, #e5e5f7 25%, #e5e5f7 75%, #8e8f98 75%, #8e8f98);\n            background-position: 0 0, 8px 8px;\n            background-size: 16px 16px;\n            outline-offset: -12px;\n            box-shadow:unset;\n            margin:10px\n        }\n\n        #seal-modal .media-preview img {\n            max-width: 100%;\n            max-height: 180px;\n            object-fit: cover;\n            overflow: hidden;\n            cursor: pointer;\n        }\n\n        #seal-modal button:hover {\n            background-color: transparent;\n        }\n\n        #seal-modal button:active {\n            position: relative;\n            top: 1px;\n        }\n\n        #seal-modal pre {\n            width: 70%;\n            color: #303a37;\n            text-wrap: auto;\n            overflow: auto;\n            line-height: unset;\n        }\n    </style>\n<div class="media-preview"><img src="${t}"></div>\n<pre>${e}</pre>\n<button id="close-modal">Close</button>\n    `,i.appendChild(n),document.body.appendChild(i);let a=document.getElementById("close-modal");a&&a.addEventListener("click",(()=>{document.body.removeChild(i)}))}chrome.runtime.onMessage.addListener((e=>n(void 0,void 0,void 0,(function*(){if("viewMediaSignature"===e.action){let t=yield function(e,t){return n(this,void 0,void 0,(function*(){try{const i=yield fetch(e);if(!i.ok)throw new Error("Failed to fetch image");const n=yield i.blob();return new File([n],t,{type:n.type})}catch(t){s(t.message,e),console.error("Error converting image src to File:",t.message)}}))}(e.url,e.url),i={};if(t){const e=new FileReader;e.readAsArrayBuffer(t),e.onload=()=>n(void 0,void 0,void 0,(function*(){i.array_buffer=e.result,i.format=null==t?void 0:t.type,i.name=null==t?void 0:t.name,function(e){n(this,void 0,void 0,(function*(){0===e.format.length&&(e.format=(0,r.detectMimeType)(e.array_buffer));let t=new a.mediaAsset(e.array_buffer,e.name);if(t.seal_segments.length>0)try{a.SEAL.parse(t),s((yield a.SEAL.validateSig(t,!0)).summary,e.name)}catch(e){console.error(e)}else s("ðŸ˜¢ No SEAL signatures found.",e.name)}))}(i)}))}}}))))},582:(e,t,i)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.mediaAsset=void 0;const n=i(109),a=new TextDecoder;t.mediaAsset=class{constructor(e,t){this.data=e,this.filename=t,this.mimeType="image/jpeg",this.seal_segments=[],this.filename=t,this.readChunks()}getDataLength(){return this.data.byteLength}readChunks(){console.time("readChunks");const e=new Uint8Array(this.data);this.data=e,this.mimeType=(0,n.detectMimeType)(e.slice(0,140));let t=!1;this.data.byteLength-65536>65536&&(t=!0);for(let i=0;i<e.length;i++)if(i>65536&&!0===t&&(i=this.data.byteLength-65536,t=!1),60==e[i]&&115==e[i+1]&&101==e[i+2]&&97==e[i+3]&&108==e[i+4]||60==e[i]&&63==e[i+1]&&115==e[i+2]&&101==e[i+3]&&97==e[i+4]&&108==e[i+5]||38==e[i]&&108==e[i+1]&&116==e[i+2]&&59==e[i+3]&&115==e[i+4]&&101==e[i+5]){const t=i;let n=!0;for(;n;)(47==e[i]&&62==e[i+1]||63==e[i]&&62==e[i+1]||47==e[i]&&38==e[i+1]&&103==e[i+2]&&116==e[i+3])&&(n=!1),i++;const r=a.decode(e.slice(t,i+1)).replace(/\\/gm,"");this.seal_segments.push({string:r,signature_end:i-2})}console.timeEnd("readChunks")}dumpInfo(){console.log(this)}assembleBuffer(e){const t=e.reduce(((e,[t,i])=>e+(i-t)),0),i=new Uint8Array(t);let n=0;return e.forEach((([e,t])=>{const a=this.data.slice(e,t);i.set(new Uint8Array(a),n),n+=a.byteLength})),i}}},109:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.detectMimeType=void 0;const i=new TextDecoder,n={dcdc:"application/cpl+xml","1f8b08":"application/gzip",25504446:"application/pdf","7b5c72746631":"application/rtf","526172211A0700":"application/vnd.rar","526172211a070100":"application/vnd.rar","425a68":"application/x-bzip2",7573746172003030:"application/x-tar",7573746172202e3:"application/x-tar","504b0304":"application/zip","504b0506":"application/zip","504b0708":"application/zip","2321414d52":"audio/AMR","2e736e64":"audio/basic","646e732e":"audio/basic","4d546864":"audio/midi","667479704d344120":"audio/mp4",fffb:"audio/mp3",fff3:"audio/mp3",fff2:"audio/mp3",ffe3:"audio/mp3",494433:"audio/mp3",fff1:"audio/aac",fff9:"audio/aac",57415645:"audio/wav","464f524d00":"audio/x-aiff","664c6143":"audio/x-flac","424d":"image/bmp","4449434D":"image/dcm",47494638:"image/gif","0000000C6A502020":"image/jp2",ffd8ff:"image/jpeg","89504e470d0a1a0a":"image/png","49492a00":"image/tiff","4d4d002a":"image/tiff","3c737667":"image/svg",38425053:"image/vnd.adobe.photoshop",57454250:"image/webp","010009000003":"image/wmf",d7cdc69a:"image/wmf",5035:"image/x-portable-graymap",5036:"image/x-portable-pixmap","01da01010003":"image/x-rgb","67696d7020786366":"image/x-xcf","0000001466747970336770":"video/3gpp2","0000002066747970336770":"video/3gpp2","6674797069736f6d":"video/mp4","667479704d534e56":"video/mp4","000000186674797033677035":"video/mp4","0000001c667479704d534e56012900464d534e566d703432":"video/mp4",6674797033677035:"video/mp4","00000018667479706d703432":"video/mp4","667479706d703432":"video/mp4",ffd8:"video/mpeg","000001ba":"video/mpeg","4F676753":"video/ogg",1466747970717420:"video/quicktime",6674797071742020:"video/quicktime","6d6f6f76":"video/quicktime","20667479704d3456":"video/x-flv","464c5601":"video/x-flv","1a45dfa3":"video/x-matroska"};t.detectMimeType=function(e){const t=Array.from(e.slice(0,16)).map((e=>e.toString(16).padStart(2,"0"))).join("");for(const[e,i]of Object.entries(n))if(t.includes(e))return i;let a=i.decode(e.slice(1,32));return a.includes("mp4")?"video/mp4":a.includes("heic")?"image/heif":a.includes("jumb")?"application/c2pa":a.includes("DICM")?"image/dcm":/^[\x09\x0A\x0D\x20-\x7E\x80-\xFF]*$/m.test(a)?a.includes("DOCTYPE")&&a.includes("html")?"text/html":a.includes("DOCTYPE")&&a.includes("svg")?"image/svg":"text/plain":"unknown"}},871:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(a,r){function s(e){try{d(n.next(e))}catch(e){r(e)}}function o(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}d((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.SEAL=t.ValidationError=t.mediaAsset=void 0;const a=i(582);Object.defineProperty(t,"mediaAsset",{enumerable:!0,get:function(){return a.mediaAsset}});const r=i(511),s=i(447),o=i(185),d=new TextEncoder;class c extends Error{constructor({name:e,message:t,cause:i}){super(t),this.name=e,this.cause=i}}t.ValidationError=c;class l{static parse(e){console.time("parse"),e.seal_segments[0].string.match(/&quot;/g)&&(e.seal_segments[0].signature_end=e.seal_segments[0].signature_end-5);const t=e.seal_segments[0].string.replace(/<.{0,1}seal /,"").replace(/\?{0,1}\/>/,"").replace(/&quot;/g,'"').replace("<seal:seal>","").replace("/&","").replace("&lt;seal ",""),i={},n=/ ?(.*?)=\"(.*?)\"/gm;let a;for(;null!==(a=n.exec(t));)a.index===n.lastIndex&&n.lastIndex++,i[a[1]]=a[2];switch(i.da||(i.da="sha256"),i.da){case"sha256":default:i.da="SHA-256";break;case"sha384":i.da="SHA-384";break;case"sha512":i.da="SHA-512";break;case"sha1":i.da="SHA-1"}if(!(i.seal&&i.d&&i.ka&&i.s))throw new c({name:"SEAL_RECORD_MISSING_PARAMETERS",message:"The SEAL record is incomplete"});this.record=i,console.timeEnd("parse")}static validateSig(e,t=!1){return n(this,void 0,void 0,(function*(){return new Promise(((i,a)=>n(this,void 0,void 0,(function*(){var n;let d;this.validation={digest_summary:"",signature_bytes:new Uint8Array,signature_encoding:"",verbose:t};let u=this.record.d;if(!this.public_keys[u]){let e=yield r.DoH.getDNSTXTRecords(u,"mozilla").catch((e=>a(new c({name:"DNS_LOOKUP",message:"Querying DoH "+this.record.d+" DNS for a TXT record failed",cause:e.message}))));if(!e)return;e.forEach((e=>{e.ka&&e.seal&&e.p&&(this.public_keys[u]||(this.public_keys[u]={}),"rsa"===e.ka&&(this.public_keys[u].rsa=e.p),"ec"===e.ka&&(this.public_keys[u].ec=e.p))}))}if(!this.public_keys[u])return;yield l.digest(e).catch((e=>{a(new c({name:"DIGEST_ERROR",message:"Digest can not be processed",cause:e.message}))})),yield l.doubleDigest().catch((e=>{a(new c({name:"DIGEST_ERROR",message:"doubleDigest can not be processed",cause:e.message}))}));let g=s.Crypto.getAlgorithmParameters(this.public_keys[this.record.d][this.record.ka],this.record.da,this.record.ka),h=yield s.Crypto.importCryptoKey(this.public_keys[this.record.d][this.record.ka],g).catch((e=>{a(new c({name:"KEY_IMPORT_ERROR",message:"crypto.subtle.importKey couldn't process the data",cause:e.message}))}));if(this.validation.digest2&&this.validation.signature&&h){console.time("verifySignature");let t,r,l=yield s.Crypto.verifySignature(this.validation.digest2,this.validation.signature_bytes,h,g).catch((e=>a(new c({name:"SIGNATURE_VERIFY_ERROR",message:"The signature can not be verified",cause:e.message}))));if(console.timeEnd("verifySignature"),!0===l?d=`${e.mimeType}:[${e.filename}]\nâœ… SEAL record #1 is valid.`:(l=!1,d=`${e.mimeType}:[${e.filename}]\nâ›” SEAL record #1 is NOT valid.`),r=this.validation.signature_date?(0,o.createDate)(this.validation.signature_date).toISOString():"",this.validation.verbose){this.validation.digest2=new Uint8Array(yield crypto.subtle.digest(this.record.da,this.validation.digest2));let e=s.Crypto.getCryptoKeyLength(h),i=[];null===(n=this.validation.digest_ranges)||void 0===n||n.forEach((e=>{i.push(e[0]+"-"+(e[1]-1))})),t=`${d}\n  Signature Algorithm: ${this.record.ka.toUpperCase()}, ${e} bits\n  Digest Algorithm: ${this.record.da}\n  Digest: ${Array.from(this.validation.digest1).map((e=>e.toString(16).padStart(2,"0"))).join("")}\n  Double Digest: ${Array.from(this.validation.digest2).map((e=>e.toString(16).padStart(2,"0"))).join("")}\n  Signed Bytes: ${i}\n  Signature Spans: ${this.validation.digest_summary}\n  Signed on: ${r}\n  Signed By: ${this.record.d} for user ${this.record.id}\n  Copyright: ${this.record.copyright}\n  Comment: ${this.record.info}`}else t=`${d}\n  Signature Spans: ${this.validation.digest_summary}\n  Signed By: ${this.record.d} for user ${this.record.id}\n  Copyright: ${this.record.copyright}\n  Comment: ${this.record.info}`;i({result:l,summary:t})}else a(new c({name:"VALIDATION_MISSING_PARAMETERS",message:"Double Digest or Signature is missing"}))}))))}))}static digest(e){return n(this,void 0,void 0,(function*(){return new Promise(((t,i)=>n(this,void 0,void 0,(function*(){let n,a;console.time("digest"),this.validation.digest_ranges=[],this.record.b&&(this.record.b.split(",").forEach((t=>{var r;let s,o;[s,o]=t.split("~");let d=s.split("-"),c=s.split("+");switch(d[1]?(s=d[0],d=parseInt(d[1])):d=0,c[1]?(s=c[0],c=parseInt(c[1])):c=0,s){case"F":s=0,n||(n="Start of file");break;case"f":s=e.getDataLength(),n||(n="End of file");break;case"S":s=e.seal_segments[0].signature_end-this.record.s.length,n||(n="Start of signature");break;case"s":s=e.seal_segments[0].signature_end,n||(n="End of signature");break;case"P":case"p":s=0;break;default:return i(new Error("ranges start error"))}switch(s=s+c+d,d=o.split("-"),c=o.split("+"),d[1]?(o=d[0],d=parseInt(d[1])):d=0,c[1]?(o=c[0],c=parseInt(c[1])):c=0,o){case"F":o=0,a="Start of file";break;case"f":o=e.getDataLength(),a="End of file";break;case"S":o=e.seal_segments[0].signature_end-this.record.s.length,a="start of signature";break;case"s":o=e.seal_segments[0].signature_end,a="end of signature";break;case"P":case"p":o=0;break;default:return i(new Error("ranges stop error"))}o=o+c+d,null===(r=this.validation.digest_ranges)||void 0===r||r.push([s,o]),this.validation.digest_summary=`${n} to ${a}`})),crypto.subtle.digest(this.record.da,e.assembleBuffer(this.validation.digest_ranges)).then((e=>{this.validation.digest1=new Uint8Array(e),console.timeEnd("digest"),t()})).catch((e=>{i(e)})))}))))}))}static doubleDigest(){return new Promise(((e,t)=>n(this,void 0,void 0,(function*(){console.time("doubleDigest");let i=[];if(this.record.sf&&(i=this.record.sf.split(":")),this.record.s){this.validation.signature=this.record.s;try{i.length>0?i.forEach((e=>{if("base64"!=e&&"hex"!=e&&"HEX"!=e&&"bin"!=e||(this.validation.signature_encoding=e,this.validation.signature&&(this.validation.signature=this.validation.signature.replace(e+":",""))),e.includes("date")){let t=parseInt(e.charAt(e.length-1));isNaN(t)?(this.validation.signature=this.record.s.substring(15,this.record.s.length),this.validation.signature_date=this.record.s.substring(0,14)):(this.validation.signature=this.record.s.substring(16+t,this.record.s.length),this.validation.signature_date=this.record.s.substring(0,15+t))}})):this.validation.signature_encoding="base64","hex"!=this.validation.signature_encoding&&"HEX"!=this.validation.signature_encoding||(this.validation.signature_bytes=(0,o.hexToUint8Array)(this.validation.signature)),"base64"==this.validation.signature_encoding&&(this.validation.signature_bytes=(0,o.base64ToUint8Array)(this.validation.signature))}catch(e){return t(e)}}else t(new c({name:"SIGNATURE_MISSING",message:"The signature is missing"}));let n="";this.validation.signature_date&&(n=this.validation.signature_date+":"),this.record.id&&(n=n+this.record.id+":");let a=d.encode(n);this.validation.digest1?(this.validation.digest2=(0,o.mergeBuffer)(a,this.validation.digest1),console.timeEnd("doubleDigest"),e()):t(new c({name:"DIGEST_MISSING",message:"The digest is missing"}))}))))}}t.SEAL=l,l.public_keys={},l.seals=[]},185:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createDate=t.mergeBuffer=t.hexToUint8Array=t.base64ToUint8Array=void 0,t.base64ToUint8Array=function(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i},t.hexToUint8Array=function(e){if(e.length%2!=0)throw new Error("Hex string must have an even length");const t=new Uint8Array(e.length/2);for(let i=0;i<e.length;i+=2)t[i/2]=parseInt(e.slice(i,i+2),16);return t},t.mergeBuffer=function(e,t){if(!e)return t;if(!t)return e;const i=new Uint8Array(e.byteLength+t.byteLength);return i.set(e,0),i.set(t,e.byteLength),i},t.createDate=function(e){let t,i=e.split(".");i[1]?(e=i[0],t=i[1]):t="000";const n=e.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1-$2-$3T$4:$5:$6."+t+"Z");return new Date(n)}}},t={};!function i(n){var a=t[n];if(void 0!==a)return a.exports;var r=t[n]={exports:{}};return e[n].call(r.exports,r,r.exports,i),r.exports}(927)})();